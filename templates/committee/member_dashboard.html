{% extends 'committee/committee_base.html' %}
{% load static %}
{% load math_filters %}

{% block title %}Member Dashboard{% endblock %}

{% block content %}
<div class="bg-gray-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Member Dashboard</h1>
            <p class="text-gray-500 mt-1">Your overview of committees, contributions, and payouts.</p>
        </div>

        <!-- Stats Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                <div class="bg-blue-500 text-white rounded-full h-12 w-12 flex items-center justify-center mr-4">
                    <i class="fas fa-layer-group text-xl"></i>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Active Committees</p>
                    <p class="text-2xl font-bold text-gray-800">{{ active_committees_count }}</p>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                <div class="bg-green-500 text-white rounded-full h-12 w-12 flex items-center justify-center mr-4">
                    <i class="fas fa-arrow-up text-xl"></i>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Total Contributions</p>
                    <p class="text-2xl font-bold text-gray-800">${{ total_contributions_amount|floatformat:2 }}</p>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                <div class="bg-purple-500 text-white rounded-full h-12 w-12 flex items-center justify-center mr-4">
                    <i class="fas fa-arrow-down text-xl"></i>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Total Payouts</p>
                    <p class="text-2xl font-bold text-gray-800">${{ total_payouts_amount|floatformat:2 }}</p>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="mb-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-committees" onclick="switchTab('committees')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-500">
                        My Committees
                    </button>
                    <button id="tab-contributions" onclick="switchTab('contributions')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">
                        My Contributions
                    </button>
                    <button id="tab-payouts" onclick="switchTab('payouts')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">
                        My Payouts
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="content-committees" class="tab-content">
            <!-- My Committees Section -->
            {% if committees %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for committee in committees %}
                        <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-1 transition-transform duration-300 flex flex-col">
                            <div class="p-6 flex-grow">
                                <div class="flex justify-between items-start mb-2">
                                    <h5 class="text-xl font-bold text-gray-800">{{ committee.name }}</h5>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                        {% if committee.status == 'ACTIVE' %} bg-green-100 text-green-800 {% endif %}
                                        {% if committee.status == 'PENDING' %} bg-yellow-100 text-yellow-800 {% endif %}
                                        {% if committee.status == 'COMPLETED' %} bg-blue-100 text-blue-800 {% endif %}
                                        {% if committee.status == 'CANCELLED' %} bg-red-100 text-red-800 {% endif %}
                                    ">
                                        {{ committee.get_status_display }}
                                    </span>
                                </div>
                                <p class="text-gray-600 text-sm mb-4">{{ committee.description|truncatewords:15 }}</p>
                                
                                <div class="text-sm text-gray-500 space-y-2">
                                    <div class="flex items-center">
                                        <i class="fas fa-calendar-alt w-4 mr-2"></i>
                                        <span>Starts: {{ committee.start_date|date:"d M Y" }}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-users w-4 mr-2"></i>
                                        <span>{{ committee.memberships.count }} Members</span>
                                    </div>
                                    <div class="flex items-center text-red-600 font-semibold">
                                        <i class="fas fa-stopwatch w-4 mr-2"></i>
                                        <span>Next Due: {{ committee.next_contribution_date|date:"d M Y" }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6 bg-gray-50 mt-auto">
                                <a href="{% url 'committee:member_committee_detail' pk=committee.pk %}" class="block w-full text-center bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                                    View Details
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-16 bg-white rounded-lg shadow-md">
                    <i class="fas fa-users text-5xl text-gray-400 mb-4"></i>
                    <h4 class="text-2xl font-bold text-gray-700">No Committees Joined</h4>
                    <p class="text-gray-500 mt-2">You have not joined any committees yet. Explore available committees to get started.</p>
                    <a href="{% url 'committee:committee_list' %}" class="mt-6 inline-block bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300">
                        Browse Committees
                    </a>
                </div>
            {% endif %}
        </div>

        <div id="content-contributions" class="tab-content hidden">
            <!-- My Recent Contributions -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                {% if my_contributions %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Committee</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">For Month</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for contribution in my_contributions %}
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                            <a href="{% url 'committee:member_committee_detail' pk=contribution.membership.committee.pk %}" class="text-blue-600 hover:underline">
                                                {{ contribution.membership.committee.name }}
                                            </a>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ contribution.for_month|date:"F Y" }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${{ contribution.amount_paid|floatformat:2 }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {{ contribution.get_status_class }}">
                                                {{ contribution.get_payment_status_display }}
                                            </span>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-center text-gray-500 py-8">You have not made any contributions yet.</p>
                {% endif %}
            </div>
        </div>

        <div id="content-payouts" class="tab-content hidden">
            <!-- My Recent Payouts -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                {% if my_payouts %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Committee</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paid On</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for payout in my_payouts %}
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                            <a href="{% url 'committee:member_committee_detail' pk=payout.membership.committee.pk %}" class="text-blue-600 hover:underline">
                                                {{ payout.membership.committee.name }}
                                            </a>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ payout.paid_at|date:"d M Y" }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${{ payout.total_amount|floatformat:2 }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {{ payout.get_status_class }}">
                                                {{ payout.get_status_display }}
                                            </span>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-center text-gray-500 py-8">You have not received any payouts yet.</p>
                {% endif %}
            </div>
        </div>

    </div>
</div>

<script>
    function switchTab(tabName) {
        // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(function(content) {
            content.classList.add('hidden');
        });

        // Deactivate all tab buttons
        document.querySelectorAll('nav button').forEach(function(button) {
            button.classList.remove('text-blue-600', 'border-blue-500');
            button.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
        });

        // Show the selected tab content
        document.getElementById('content-' + tabName).classList.remove('hidden');

        // Activate the selected tab button
        const activeButton = document.getElementById('tab-' + tabName);
        activeButton.classList.add('text-blue-600', 'border-blue-500');
        activeButton.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
    }
</script>
{% endblock %}
